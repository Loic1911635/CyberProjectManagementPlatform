{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>{{ task.title }}</h1>
            <p style="color: #718096; font-size: 0.95rem;">
                <i class="fas fa-folder"></i> 
                <a href="{{ url_for('project_detail', project_id=task.project_id) }}" style="color: #667eea; text-decoration: none;">
                    {{ task.project.name }}
                </a>
            </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-warning"><i class="fas fa-edit"></i> Edit</a>
            <a href="{{ url_for('project_detail', project_id=task.project_id) }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back</a>
        </div>
    </div>

    <!-- Task Status & Priority -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 style="margin-bottom: 1rem; font-weight: 700;"><i class="fas fa-flag"></i> Status</h6>
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn status-btn" data-status="todo" 
                            {% if task.status == 'todo' %}active style="background: #cbd5e0; color: #1a202c; border: none;"{% endif %}>
                            <i class="fas fa-circle-notch"></i> To Do
                        </button>
                        <button type="button" class="btn status-btn" data-status="in_progress"
                            {% if task.status == 'in_progress' %}active style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white; border: none;"{% endif %}>
                            <i class="fas fa-spinner"></i> In Progress
                        </button>
                        <button type="button" class="btn status-btn" data-status="done"
                            {% if task.status == 'done' %}active style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border: none;"{% endif %}>
                            <i class="fas fa-check-circle"></i> Done
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 style="margin-bottom: 1rem; font-weight: 700;"><i class="fas fa-exclamation"></i> Priority</h6>
                    <div>
                        {% if task.priority == 'low' %}
                            <span class="badge" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; font-size: 0.95rem; padding: 0.6rem 1rem;">
                                <i class="fas fa-arrow-down"></i> Low Priority
                            </span>
                        {% elif task.priority == 'medium' %}
                            <span class="badge" style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white; font-size: 0.95rem; padding: 0.6rem 1rem;">
                                <i class="fas fa-equals"></i> Medium Priority
                            </span>
                        {% else %}
                            <span class="badge" style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); color: white; font-size: 0.95rem; padding: 0.6rem 1rem;">
                                <i class="fas fa-arrow-up"></i> High Priority
                            </span>
                        {% endif %}
                    </div>
                    {% if task.due_date %}
                    <p style="margin-top: 1rem; margin-bottom: 0;"><i class="fas fa-calendar"></i> <strong>Due:</strong> {{ task.due_date.strftime('%B %d, %Y') }}</p>
                    {% endif %}
                    {% if task.assigned_to %}
                    <p style="margin-top: 0.5rem; margin-bottom: 0;"><i class="fas fa-user"></i> <strong>Assigned to:</strong> {{ task.assigned_to.username }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Task Description -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-file-alt"></i> Description
        </div>
        <div class="card-body">
            {% if task.description %}
                <p style="white-space: pre-wrap; color: #2d3748;">{{ task.description }}</p>
            {% else %}
                <p style="color: #718096;"><em>No description provided</em></p>
            {% endif %}
        </div>
    </div>

    <!-- Subtasks / Task Statuses -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-tasks"></i> Subtasks 
            <span class="badge" style="background: #667eea; color: white; margin-left: 0.5rem;">
                {{ subtasks|selectattr('completed')|list|length }}/{{ subtasks|length }} Completed
            </span>
            <span style="margin-left: 1rem; color: #667eea; font-weight: 700;">{{ completion }}% Done</span>
        </div>
        <div class="card-body">
            <!-- Progress Bar -->
            <div style="margin-bottom: 2rem;">
                <div style="background: #e2e8f0; border-radius: 10px; height: 20px; overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: {{ completion }}%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: 700;">
                        {% if completion > 10 %}{{ completion }}%{% endif %}
                    </div>
                </div>
            </div>

            <!-- Subtasks List -->
            {% if subtasks %}
            <div style="margin-bottom: 2rem;">
                {% for subtask in subtasks %}
                <div class="subtask-item" style="display: flex; align-items: center; padding: 0.75rem; background: #f7fafc; border-radius: 8px; margin-bottom: 0.5rem; transition: all 0.2s ease;">
                    <input type="checkbox" class="subtask-checkbox" data-subtask-id="{{ subtask.id }}" 
                        {% if subtask.completed %}checked{% endif %} 
                        style="width: 20px; height: 20px; cursor: pointer; margin-right: 1rem;">
                    <span class="subtask-text" style="flex: 1; {% if subtask.completed %}text-decoration: line-through; color: #a0aec0;{% endif %}">
                        {{ subtask.title }}
                    </span>
                    <button type="button" class="btn btn-sm btn-danger delete-subtask" data-subtask-id="{{ subtask.id }}">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Add Subtask Form -->
            <form id="add-subtask-form" style="display: flex; gap: 0.5rem;">
                <input type="text" id="subtask-input" class="form-control" placeholder="Add a new subtask..." required>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add
                </button>
            </form>
        </div>
    </div>
</div>

<script>
// Change task status
document.querySelectorAll('.status-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const newStatus = this.dataset.status;
        try {
            const response = await fetch(`/task/{{ task.id }}/status/${newStatus}`, {
                method: 'POST'
            });
            const data = await response.json();
            if (data.success) {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to update status');
        }
    });
});

// Toggle subtask
document.querySelectorAll('.subtask-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', async function() {
        const subtaskId = this.dataset.subtaskId;
        try {
            const response = await fetch(`/subtask/${subtaskId}/toggle`, {
                method: 'POST'
            });
            const data = await response.json();
            if (data.success) {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });
});

// Delete subtask
document.querySelectorAll('.delete-subtask').forEach(btn => {
    btn.addEventListener('click', async function() {
        if (!confirm('Delete this subtask?')) return;
        const subtaskId = this.dataset.subtaskId;
        try {
            const response = await fetch(`/subtask/${subtaskId}/delete`, {
                method: 'POST'
            });
            const data = await response.json();
            if (data.success) {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });
});

// Add subtask
document.getElementById('add-subtask-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const title = document.getElementById('subtask-input').value.trim();
    if (!title) return;
    
    try {
        const formData = new FormData();
        formData.append('title', title);
        const response = await fetch(`/task/{{ task.id }}/subtask/new`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        if (data.success) {
            location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
    }
});
</script>
{% endblock %}